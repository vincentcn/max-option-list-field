<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="max-option-list-field">
  <template>
    <style>
      :host {
        display: block;
      }

      :host #container {
        margin-top: 5px;
        margin-bottom: 20px;
        margin-left: 5px;
        margin-right: 5px;
      }

      :host #label-for-select {
        display: block;
        margin-bottom: -10px;
      }

    </style>
    <div id="container">
      <template is="dom-if" if="{{_isNotEmptyString(selectLabel)}}">
        <label for="selectInput" id="label-for-select">[[selectLabel]]</label><br>
      </template>
      <select id="selectInput" selectedItem="[[selectedItem]]">
        <template is="dom-repeat" items={{_parsedOptions}} as="option">
          <<option option-index="[[index]]" value="[[option.value]]">[[option.name]]</option>
        </template>
      </select>
      <template is="dom-if" if="{{_isNotEmptyString(optionsRequestUrl)}}">
        <iron-ajax url="[[optionsRequestUrl]]" handle-as="json" last-response="{{_optionsRequestResponse}}" auto></iron-ajax>
      </template>
    </div>
  </template>

  <script>
    /**
     * `max-option-list-field`
     * A polymer 2 element used as the option list control in max project
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class MaxOptionListField extends Polymer.Element {
      static get is() { return 'max-option-list-field'; }
      static get properties() {
        return {
          /**
           * The lable for the select options input.
          */
          selectLabel: {
            type: String
          },

          /**
           * Curret selected item.
          */
          selectedItem: {
            type: String
          },

          /**
           * The options. The format is
           * [
           *   { name : "option 1", value: "option1"},
           *   { name : "option 2", value: "option2"}
           * ]
          */
          selectOptions: {
            type: Array,
            value: [
                      {
                        "value" : "default",
                        "name" : "default"
                      }
                    ]
          },

          /**
           * The request url used to fetch options.
           * If this field is specified, it will fetch the options via an ajax
           * request automatically.
          */
          optionsRequestUrl: {
            type: String
          },

          /**
           * Specify which field in feed data will be used as the name of option.
           * Defaults to "name".
          */
          nameFieldInOption: {
            type: String,
            value: "name"
          },

          /**
           * Specify which field in feed data will be used as the value of option.
           * Defaults to "value".
          */
          valueFieldInOption: {
            type: String,
            value: "value"
          },

          _parsedOptions: {
            type: Array
          },

          _optionsRequestResponse: {
            type: Object
          }
        };
      }

      static get observers() {
        return [
            '_parseRequestedOptions(_optionsRequestResponse, nameFieldInOption, valueFieldInOption)',
            '_parseConfiguredOptions(selectOptions, nameFieldInOption, valueFieldInOption)'
        ]
      }

      _isNotEmptyString(value) {
        return (typeof value === "string") && (value.trim().length > 0);
      }

      _parseConfiguredOptions(options, nameField, valueField) {
        this._parseOptions(options, nameField, valueField);
      }

      _parseRequestedOptions(options, nameField, valueField) {
        this._parseOptions(options, nameField, valueField);
      }

      _parseOptions(options, nameField, valueField) {
        if (options && nameField && valueField) {
          var parsedOptions = [];

          options.forEach(function(option) {
            var name = option[nameField];
            var value = option[valueField];
            if (name && value) {
              parsedOptions.push({"name": name, "value": value});
            }
          });

          if (parsedOptions.length > 0) {
            this._parsedOptions = parsedOptions;
          }
        }
      }
    }

    window.customElements.define(MaxOptionListField.is, MaxOptionListField);
  </script>
</dom-module>
